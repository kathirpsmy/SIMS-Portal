{% extends "layout.html" %}
{% block content %}
<style>
.btn-danger, .btn-danger:visited, .btn-danger:active {
    color: #fff !important;
}
</style>
<div class="container">
    <div id="hideMe">
        {% with messages = get_flashed_messages(with_categories=true) %}
               {% if messages %}
                   {% for category, message in messages %}
                       <div class="mt-2 alert alert-{{ category }}">
                           {{ message }} 
                       </div>
                   {% endfor %}
               {% endif %}
        {% endwith %}
    </div>
    <div class="row mt-3 mb-5">
    <div class="col col-md-3 rounded rounded-3 mb-5">
        <div class="card p-4 bg-danger mt-5 position-sticky" style="top: 15px;">
                <div class="row">
                    <div>
                        <h5 class="text-light Montserrat mb-3">Admin Controls</h5>
                    <ul class="list-group border-0">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="/admin/manage_profiles" class="text-secondary">
                                <i data-feather="user" class="mr-3"></i>
                                &nbsp Manage Profiles
                            </a>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="text-secondary">
                                <i data-feather="award" class="mr-3"></i> 
                                &nbsp Assign Badges
                            </div>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="/admin/upload_badges" class="text-secondary">
                                <i data-feather="upload" class="mr-3"></i> 
                                &nbsp Upload Badges
                            </a>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="/admin/approve_members" class="text-secondary">
                                <i data-feather="thumbs-up" class="mr-3"></i> 
                                &nbsp Approve Members
                            </a>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="/admin/process_reviews" class="text-secondary">
                                <i data-feather="book-open" class="mr-3"></i> 
                                &nbsp Open Reviews
                            </a>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="/admin/edit_skills" class="text-secondary">
                                <i data-feather="list" class="mr-3"></i> 
                                &nbsp Skills List
                            </a>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="/admin/process_acronyms" class="text-secondary">
                                <i data-feather="pen-tool" class="mr-3"></i> 
                                &nbsp Process Acronyms
                            </a>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="/admin/assign_regional_focal_point" class="text-secondary">
                                <i data-feather="globe" class="mr-3"></i> 
                                &nbsp Focal Points
                            </a>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="/admin/view_logs" class="text-secondary">
                                <i data-feather="activity" class="mr-3"></i> 
                                &nbsp Activity Logs
                            </a>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="/admin/send_slack_message" class="text-secondary">
                                <i data-feather="slack" class="mr-3"></i> 
                                &nbsp Slack Message
                            </a>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="#" class="text-secondary active-link">
                                <i data-feather="check" class="mr-3"></i> 
                                &nbsp Checklists
                            </a>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="/manual_refresh" class="text-secondary">
                                <i data-feather="refresh-ccw" class="mr-3"></i> 
                                &nbsp Manual Refresh
                            </a>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="/admin" class="text-secondary">
                                <i data-feather="settings" class="mr-3"></i> 
                                &nbsp Admin Backend
                            </a>
                        </li>
                    </ul>
                    </div>
                </div>
            </div>		
        </div>
        <div class="col g-5">

            <!-- Tab navigation -->
            <ul class="nav nav-pills mb-5" id="admin-checklist-nav" role="tablist">
                <li class="nav-item" role="presentation">
                <button class="nav-link {{ 'active' if active_tab != 'emergency-checklist' and active_tab != 'task-report' else '' }}" id="manage-checklist-tab" data-bs-toggle="pill" data-bs-target="#manage-checklist" type="button" role="tab" aria-controls="manage-checklist" aria-selected="true">Manage Checklist</button>
                </li>
                <li class="nav-item" role="presentation">
                <button class="nav-link {{ 'active' if active_tab == 'emergency-checklist' else '' }}" id="emergency-checklist-tab" data-bs-toggle="pill" data-bs-target="#emergency-checklist" type="button" role="tab" aria-controls="emergency-checklist" aria-selected="false">Emergency Checklist</button>
                </li>
                <li class="nav-item" role="presentation">
                <button class="nav-link {{ 'active' if active_tab == 'task-report' else '' }}" id="task-report-tab" data-bs-toggle="pill" data-bs-target="#task-report" type="button" role="tab" aria-controls="task-report" aria-selected="false">Task Report</button>
                </li>
            </ul>

            <div class="tab-content" id="admin-checklist-content">
                <div class="tab-pane fade show {{ 'active' if active_tab != 'emergency-checklist' else '' }}" id="manage-checklist" role="tabpanel" aria-labelledby="manage-checklist-tab">
                    <h2 class="text-danger Montserrat mb-4">Checklist</h2>
                    <h5 class="text-danger Montserrat">Checklist Details</h5>
                    <p id="sidebar-guidance">The checklist is a collection of tasks that need to be completed. Please provide a clear and concise description of each task.</p>
                
                    <div class="col">
                        <form action="{{ url_for('main.add_checklist') }}" method="POST" class="mb-4">
                            {{ new_checklist_form.hidden_tag() }}
                            <div class="row g-3">
                                <div class="col-md-4">
                                    {{ new_checklist_form.task_name(class="form-control", placeholder="Task Name") }}
                                </div>
                                <div class="col-md-4">
                                    {{ new_checklist_form.task_description(class="form-control", placeholder="Description") }}
                                </div>
                                <div class="col-md-3">
                                    {{ new_checklist_form.task_url(class="form-control", placeholder="URL") }}
                                </div>
                                <div class="col-md-1">
                                    <button type="submit" class="btn btn-primary">Add Task</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <table class='table table-striped table-hover mt-5'>
                        <thead>
                            <tr>
                                <th style="width: 30%">Task Name</th>
                                <th style="width: 50%">Description</th>
                                <th style="width: 20%">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for checklist in checklists %}
                            <tr>
                                <td>
                                    {% if checklist.task_url %}
                                        <a href="{{ checklist.task_url }}" target="_blank">{{ checklist.task_name }}</a>
                                    {% else %}
                                        {{ checklist.task_name }}
                                    {% endif %}
                                </td>
                                <td>{{ checklist.task_description }}</td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <a href="{{ url_for('main.edit_checklist', id=checklist.id) }}" class="btn btn-sm btn-warning">Edit</a>
                                        <a href="{{ url_for('main.remove_checklist', id=checklist.id) }}" class="btn btn-sm btn-danger">Remove</a>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="3">
                                    <div class="p-3 mb-4 border rounded bg-light">
                                    <!-- Sub-Tasks Table -->
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <h6 class="mb-0">Sub-Tasks</h6>
                                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#subtasks-{{ checklist.id }}" aria-expanded="false">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    <div class="collapse" id="subtasks-{{ checklist.id }}">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th style="width: 30%">Name</th>
                                                    <th style="width: 50%">Description</th>
                                                    <th style="width: 20%">Actions</th>
                                                </tr>
                                            </thead>
                                        <tbody>
                                            {% for subtask in checklist.sub_tasks|sort(attribute='id') %}
                                            <tr>
                                                <td>
                                                    {% if subtask.task_url %}
                                                        <a href="{{ subtask.task_url }}" target="_blank">{{ subtask.name }}</a>
                                                    {% else %}
                                                        {{ subtask.name }}
                                                    {% endif %}
                                                </td>
                                                <td>{{ subtask.description }}</td>
                                                <td>
                                                    <div class="d-flex gap-2">
                                                        <a href="{{ url_for('main.edit_subtask', subtask_id=subtask.id) }}" class="btn btn-sm btn-warning">Edit</a>
                                                        <a href="{{ url_for('main.remove_subtask', subtask_id=subtask.id) }}" class="btn btn-sm btn-danger">Remove</a>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <!-- Add Sub-Task Form -->
                                    <form action="{{ url_for('main.add_subtask', checklist_id=checklist.id) }}" method="POST" class="row g-2">
                                        {{ subtask_forms[checklist.id].hidden_tag() }}
                                        <div class="col-md-3">
                                            {{ subtask_forms[checklist.id].name(class_="form-control", placeholder="Sub-Task Name") }}
                                            {% for error in subtask_forms[checklist.id].name.errors %}
                                                <div class="text-danger small">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                        <div class="col-md-4">
                                            {{ subtask_forms[checklist.id].description(class_="form-control", placeholder="Description") }}
                                            {% for error in subtask_forms[checklist.id].description.errors %}
                                                <div class="text-danger small">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                        <div class="col-md-3">
                                            {{ subtask_forms[checklist.id].task_url(class_="form-control", placeholder="URL") }}
                                            {% for error in subtask_forms[checklist.id].task_url.errors %}
                                                <div class="text-danger small">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                        <div class="col-md-2">
                                            <button type="submit" class="btn btn-success">Add Sub-Task</button>
                                        </div>
                                    </form>
                                    </div>
                                    </div>
                                </td>
                            </tr>
                            <tr><td colspan="3"><hr class="my-4"></td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="tab-pane fade {{ 'show active' if active_tab == 'emergency-checklist' else '' }}" id="emergency-checklist" role="tabpanel" aria-labelledby="emergency-checklist-tab">
                    <h3>Emergency Checklist</h3>
                    <p id="sidebar-guidance">The emergency checklist is a collection of tasks that need to be completed during an emergency. This section is only for active emergencies. Select an emergency to view and update its assigned tasks and sub-tasks.</p>
                    <div class="mb-3">
                        <form id="emergency-select-form" method="get" action="{{ url_for('main.update_emergency_checklist') }}">
                            {{ assign_form.emergency_id.label(class="form-label") }}
                            <select name="emergency_id" class="form-select" onchange="document.getElementById('emergency-select-form').submit();">
                                <option value="">-- Select Emergency --</option>
                                {% for e in active_emergencies %}
                                    <option value="{{ e.id }}" {% if assign_form.emergency_id.data == e.id %}selected{% endif %}>{{ e.emergency_name }}</option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>
                    <form id="emergency-checklist-form" action="{{ url_for('main.update_emergency_checklist') }}" method="POST">
                        {{ assign_form.hidden_tag() }}
                        <input type="hidden" name="emergency_id" value="{{ assign_form.emergency_id.data }}">
                        <div class="mb-3">
                            <label class="form-label">Select Tasks and Sub-Tasks</label>
                            <div class="accordion" id="checklistAccordion">
                                {% for checklist in checklists %}
                                {% set expanded = false %}
                                {% for subtask in checklist.sub_tasks %}
                                    {% if subtask.id in assigned_subtask_ids %}
                                        {% set expanded = true %}
                                    {% endif %}
                                {% endfor %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading{{ checklist.id }}">
                                        <button class="accordion-button {% if not expanded %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ checklist.id }}" aria-expanded="{{ 'true' if expanded else 'false' }}" aria-controls="collapse{{ checklist.id }}">
                                            <input type="checkbox" name="tasks" value="{{ checklist.id }}" {% if checklist.id in assigned_task_ids %}checked{% endif %}> {{ checklist.task_name }}
                                        </button>
                                    </h2>
                                    <div id="collapse{{ checklist.id }}" class="accordion-collapse collapse {% if expanded %}show{% endif %}" aria-labelledby="heading{{ checklist.id }}" data-bs-parent="#checklistAccordion">
                                        <div class="accordion-body">
                                            <ul class="list-group">
                                                {% for subtask in checklist.sub_tasks %}
                                                <li class="list-group-item">
                                                    <input type="checkbox" name="subtasks_{{ checklist.id }}" value="{{ subtask.id }}" {% if subtask.id in assigned_subtask_ids %}checked{% endif %}> {{ subtask.name }}
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Assignments</button>
                    </form>

                    {% if assign_form.emergency_id.data %}
                    <div class="mt-4">
                        <h4>Task Status</h4>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Task</th>
                                        <th>Status</th>
                                        <th>Completed Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for assignment in assignment_checklists %}
                                    {% if assignment.emergency_id == assign_form.emergency_id.data %}
                                    <tr>
                                        <td>{{ assignment.checklist.task_name }}</td>
                                        <td>
                                            {% if assignment.task_completed %}
                                                <span class="badge bg-success">Completed</span>
                                            {% else %}
                                                <span class="badge bg-warning">Pending</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if assignment.task_completed_date %}
                                                {{ assignment.task_completed_date.strftime('%Y-%m-%d %H:%M:%S') }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            <form action="{{ url_for('main.update_task_status', assignment_id=assignment.id) }}" method="POST" class="d-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <div class="input-group">
                                                    <input type="datetime-local" name="completed_date" class="form-control form-control-sm" value="{{ assignment.task_completed_date.strftime('%Y-%m-%dT%H:%M') if assignment.task_completed_date else '' }}">
                                                    <button type="submit" class="btn btn-sm btn-primary">Update</button>
                                                </div>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Task Report Tab -->
                <div class="tab-pane fade {{ 'show active' if active_tab == 'task-report' else '' }}" id="task-report" role="tabpanel" aria-labelledby="task-report-tab">
                    <h3>Task Report</h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Emergency</th>
                                    <th>Total Tasks</th>
                                    <th>Total Sub-Tasks</th>
                                    <th>Completed Tasks</th>
                                    <th>Completion Rate</th>
                                    <th>Last Update</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for emergency in active_emergencies %}
                                {% set stats = get_emergency_task_stats(emergency.id) %}
                                <tr>
                                    <td>{{ emergency.emergency_name }}</td>
                                    <td>{{ stats.total_tasks }}</td>
                                    <td>{{ stats.total_subtasks }}</td>
                                    <td>{{ stats.completed_tasks }}</td>
                                    <td>{{ "%.2f"|format(stats.completion_rate) }}%</td>
                                    <td>{{ stats.last_update.strftime('%Y-%m-%d %H:%M:%S') if stats.last_update else '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
            </div>
        
        </div>
    </div>
</div>

{% endblock content %}
